(()=>{"use strict";const e=class{constructor(e,t){this._con=e,this._fetch=t,this._status=null,t.then((e=>{this._status=e.status}))}abort(){this._con.abort()}get status(){return this._status}async _request(){return(await this._fetch).clone()}async valid(){return await this._fetch,this}};for(const t of["text","json","blob","arrayBuffer","formData"])e.prototype[t]=async function(){return await(await this._request())[t]()};const t=(t,n={})=>{const a=new AbortController;return new e(a,fetch(t,{...n,signal:a.signal}))},n=e=>{const t=new TextDecoder("shift-jis").decode(e);return(new DOMParser).parseFromString(t,"text/html")},a={"．":".","～":"~","－":"-","　":" "},i=new RegExp("("+Object.keys(a).join("|")+")","g"),r=()=>new Promise((e=>{chrome.storage.local.get(["__akizuki_my_item_list"],(t=>e([...t.__akizuki_my_item_list||[]])))})),o=document.createElement("style");o.innerHTML="\n.__akizuki_info_box {\n    animation: __akizuki_info_box_close_animation .35s ease-in 1s forwards;\n    position: fixed;\n    pointer-events: none;\n    user-select: none;\n    top: 1em;\n    left: 0;\n    right: 0;\n    margin: 0 auto;\n    background: #ffcc99;\n    border: 1px solid #aaa;\n    box-shadow: 0 0 3px #fff, 0 0 6px #fff, 0 0 9px #fff;\n    color: #733;\n    font-size: 1.5em;\n    opacity: 1;\n    padding: .5em;\n    text-align: center;\n    width: 35%;\n    max-width: 190px;\n}\n@keyframes __akizuki_info_box_close_animation {\n  0%,30% { opacity: 1; }\n  100%   { opacity: 0; }\n}\n",document.head.appendChild(o);const s=document.createElement("div");s.classList.add("__akizuki_info_box","__akizuki_close","__akizuki_init"),chrome.runtime.onMessage.addListener((async(e,o,c)=>{if("add_item"==e.name){const{id:o}=e.payload;await(async e=>await(async e=>{const t=await r(),n=await e(t);return await new Promise((e=>{chrome.storage.local.set({__akizuki_my_item_list:n.sort(((e,t)=>Number(e.stock["秋葉原店"].cabinet)-Number(t.stock["秋葉原店"].cabinet)))},(async()=>{e(await r())}))}))})((async r=>{const o=r.find((t=>t.id==e)),s=await(async e=>{if(!(e=>e.match(/^[MKPBRSICT]-\d{5}$/))(e))return null;const r=[`https://akizukidenshi.com/catalog/g/g${e}/`,`https://akizukidenshi.com/img/goods/S/${e}.jpg`,`https://akizukidenshi.com/catalog/goods/warehouseinfo.aspx?goods=${e}`].map(t);if(await r[0].valid()&&404!=r[0].status)return await(async(e,t,r,o)=>{const s={},c=n(t),l=c.querySelector(".goodsspec_"),u=c.querySelector(".cart_table h6");if(l){s.name=l.querySelector(".name1_").innerText;const e=[...l.querySelector(".cart_").children].filter((e=>"P"==e.nodeName)).map((e=>e.innerText.trim().replace(/\s+/g," "))).join("\n");s.price=e}else{if(!u)return null;s.name=u.innerText,s.price=c.querySelector(".order_g > table td").innerText.replace(/\s+/g," ")}s.name=s.name.replace(/\s+/g," ").replace(/[Ａ-Ｚａ-ｚ０-９]/g,(e=>String.fromCharCode(e.charCodeAt(0)-65248))).replace(i,(e=>a[e])),s.price=s.price.replace(/合計[\s\S]+$/,"").trim();const m=[...n(o).querySelectorAll("tr:not([align])")].map((e=>{const t={},n=e.querySelectorAll("td");return t.name=n[0].innerText.trim(),t.limit=n[1].innerText.trim(),t.location=n[2].innerText.trim(),t}));return s.id=e,s.icon=r,s.count=1,s.stock=m.reduce(((e,t)=>("秋葉原店"==t.name&&(t.cabinet=t.location.match(/\s(\d{2})/)?.[1]||null),e[t.name]=t,e)),{}),s})(e,await r[0].arrayBuffer(),await(o=await r[1].blob(),new Promise((e=>{const t=new FileReader;t.onload=()=>e(t.result),t.readAsDataURL(o)}))),await r[2].arrayBuffer());for(const e of r)try{e.abort()}catch(e){}var o;return null})(e);return o||!s?r:[...r,s]})))(o),console.log(o),s.remove(),s.innerHTML=`${o}を追加`,document.body.appendChild(s)}}))})();