{"version":3,"file":"contentScript.js","mappings":";;;;;;;;;;;;;;;;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEO,mCAAmC;AAC1C;AACA,qDAAqD,2BAA2B;AAChF;;AAEO;AACP;AACA;;;;;;;;;;;;;;;;;;ACrCoD;;AAEpD;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,CAAC;;AAED;AACA;AACA;AACA;AACA;AACA;;AAEO,yDAAyD,EAAE;;AAE3D;AACP;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEO;AACP;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;;AAEA;AACA;AACA,gDAAgD,EAAE;AAClD;AACA;AACA;AACA,KAAK,IAAI;;AAET;AACA;;AAEO;AACP;AACA;AACA,gDAAgD,GAAG;AACnD,iDAAiD,GAAG;AACpD,4EAA4E,GAAG;AAC/E,UAAU,8DAAc;AACxB;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAM;AACN;AACA;AACA;AACA,aAAa;AACb;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,wEAAwE,GAAG;AAC3E;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA,sEAAsE,GAAG;AACzE;AACA;AACA,iGAAiG,GAAG;AACpG;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;;AAEA;AACA;AACA,gDAAgD,EAAE;AAClD;AACA;AACA;AACA,KAAK,IAAI;;AAET;AACA,EAAE;;;;;;;;;;;;;;;;;;ACpLqC;;;AAGhC;AACP;AACA,CAAC;;AAEM;AACP;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA,SAAS;AACT,KAAK;AACL;;AAEO;AACP;AACA;AACA,8BAA8B,oDAAS;AACvC;AACA;AACA;AACA,KAAK;AACL;AACA;;AAEO,yDAAyD;AAChE;AACA;AACA;AACA,mCAAmC,oDAAS;AAC5C;AACA;AACA,gBAAgB;AAChB,KAAK;AACL;AACA;AACA,CAAC;;;;;;;UC1CD;UACA;;UAEA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;;UAEA;UACA;;UAEA;UACA;UACA;;;;;WCtBA;WACA;WACA;WACA;WACA,yCAAyC,wCAAwC;WACjF;WACA;WACA;;;;;WCPA;;;;;WCAA;WACA;WACA;WACA,uDAAuD,iBAAiB;WACxE;WACA,gDAAgD,aAAa;WAC7D;;;;;;;;;;;;ACNoC;;AAEpC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,WAAW;AACX,WAAW;AACX;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA,gBAAgB,KAAK;AACrB,cAAc,iDAAO;AACrB;AACA;AACA,4BAA4B,GAAG;AAC/B;AACA;;AAEA;AACA;AACA,mBAAmB;AACnB;AACA,CAAC","sources":["webpack://akizuki-chrome-ext/./src/abortableFetch.js","webpack://akizuki-chrome-ext/./src/parse.js","webpack://akizuki-chrome-ext/./src/util.js","webpack://akizuki-chrome-ext/webpack/bootstrap","webpack://akizuki-chrome-ext/webpack/runtime/define property getters","webpack://akizuki-chrome-ext/webpack/runtime/hasOwnProperty shorthand","webpack://akizuki-chrome-ext/webpack/runtime/make namespace object","webpack://akizuki-chrome-ext/./src/contentScript.js"],"sourcesContent":["\nconst AbortableFetchObject = class {\n    constructor(_con, _fetch) {\n        this._con = _con;\n        this._fetch = _fetch;\n        this._status = null;\n        _fetch.then(r => {\n            this._status = r.status\n        })\n    }\n    abort() {\n        this._con.abort();\n    }\n    get status() {\n        return this._status;\n    }\n    async _request() {\n        return (await this._fetch).clone();\n    }\n    async valid() {\n        await this._fetch;\n        return this;\n    }\n}\nfor(const m of ['text', 'json', 'blob', 'arrayBuffer', 'formData']) {\n    AbortableFetchObject.prototype[m] = async function() {\n        return await (await this._request())[m]();\n    };\n};\n\nexport const abortableFetch = (url, opt={}) => {\n    const con = new AbortController();\n    return new AbortableFetchObject(con, fetch(url, {...opt, signal: con.signal}));\n};\n\nexport const abortableFetchList = async (...af) => {\n    return await Promise.all(af.map(f => f._request()));\n};","import { abortableFetch } from './abortableFetch.js'\n\nconst Decode_ShiftJis_Dom = buf => {\n    const t = new TextDecoder('shift-jis').decode(buf);\n    return (new DOMParser()).parseFromString(t, 'text/html');\n};\n\nconst Blob2Base64 = blob => new Promise(res => {\n    const reader = new FileReader;\n    reader.onload = () => res(reader.result);\n    reader.readAsDataURL(blob);\n});\n\nconst ZenkakuFig = {\n    '．': '.',\n    '～': '~',\n    '－': '-'\n};\nconst ZenkakuFigReg = new RegExp('(' + Object.keys(ZenkakuFig).join('|') + ')', 'g');\n\nexport const checkValidItemId = id => id.match(/^[MKPBRSICT]-\\d{5}$/);\n\nexport const AkizukiPrice = class {\n    constructor(str) {\n        this.ary = [...str.matchAll(/(\\d+)[\\s\\S]+?￥([\\d,]+)/g)]\n            .map(a => a.slice(1)\n                .map(n => Number(n.replace(/,/g, ''))))\n            .reverse();\n    }\n    calc(n) {\n        for(const x of this.ary) {\n            if(x[0] <= n) return n * x[1];\n        }\n        return 0;\n    }\n};\n\nexport const ParseItemFromRawRequest = async (id, catalog_arrayBuffer, icon_base64, info_arraybuffer) => {\n    const result = {};\n    const catalog_dom = Decode_ShiftJis_Dom(catalog_arrayBuffer);\n    const spec = catalog_dom.querySelector('.goodsspec_');\n    const h6 = catalog_dom.querySelector('.cart_table h6');\n    if(spec) {\n        result.name = spec.querySelector('.name1_').innerText;\n        const _cart = spec.querySelector('.cart_');\n        const _price = [..._cart.children]\n            .filter(e => e.nodeName == 'P')\n            .map(e => e.innerText.trim().replace(/\\s+/g, ' '))\n            .join('\\n');\n        result.price = _price;\n    }\n    else if(h6) {\n        result.name = h6.innerText;\n        result.price = catalog_dom.querySelector('.order_g > table td').innerText\n            .replace(/\\s+/g, ' ');\n    }\n    else {\n        return null;\n    }\n\n    result.name = result.name\n        .replace(/\\s+/g, ' ')\n        .replace(/[Ａ-Ｚａ-ｚ０-９]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0))// 全角英数字 -> 半角英数字\n        .replace(ZenkakuFigReg, s => ZenkakuFig[s])\n    result.price = result.price.replace(/合計[\\s\\S]+$/, '').trim();\n\n    const info_dom = Decode_ShiftJis_Dom(info_arraybuffer);\n\n    const stock = [...info_dom.querySelectorAll('tr:not([align])')]\n        .map(tr => {\n            const obj = {};\n            const tds = tr.querySelectorAll('td');\n            obj.name = tds[0].innerText.trim();\n            obj.limit = tds[1].innerText.trim();\n            obj.location = tds[2].innerText.trim();\n            return obj;\n    });\n    \n    result.id = id;\n    result.icon = icon_base64;\n    result.count = 1;\n\n    result.stock = stock.reduce((p, v) => {\n        if(v.name == '秋葉原店') {\n            v.cabinet = v.location.match(/\\s(\\d{2})/)?.[1] || null;\n        }\n        p[v.name] = v;\n        return p;\n    }, {});\n\n    return result;\n}\n\nexport const ParseItem = async id => {\n    if(!checkValidItemId(id)) return null;\n    const reqs = [\n        `https://akizukidenshi.com/catalog/g/g${id}/`,\n        `https://akizukidenshi.com/img/goods/S/${id}.jpg`,\n        `https://akizukidenshi.com/catalog/goods/warehouseinfo.aspx?goods=${id}`\n    ].map(abortableFetch);\n    if(await reqs[0].valid() && reqs[0].status != 404) {\n        return await ParseItemFromRawRequest(\n            id,\n            await reqs[0].arrayBuffer(),\n            await Blob2Base64(await reqs[1].blob()),\n            await reqs[2].arrayBuffer()\n        );\n    } else {\n        for(const req of reqs) {\n            try {\n                req.abort();\n            }catch(e){}\n        }\n    }\n    return null;\n};\n\n/*\nexport const ParseItem = async id => {\n    if(!checkValidItemId(id)) return null;\n    const catalog = await fetch(`https://akizukidenshi.com/catalog/g/g${id}/`);\n    if(catalog.status == 404) return null;\n\n    const result = {};\n    const catalog_dom = Decode_ShiftJis_Dom(await catalog.arrayBuffer());\n    const spec = catalog_dom.querySelector('.goodsspec_');\n    const h6 = catalog_dom.querySelector('.cart_table h6');\n    if(spec) {\n        result.name = spec.querySelector('.name1_').innerText;\n        const _cart = spec.querySelector('.cart_');\n        const _price = [..._cart.children]\n            .filter(e => e.nodeName == 'P')\n            .map(e => e.innerText.trim().replace(/\\s+/g, ' '))\n            .join('\\n');\n        result.price = _price;\n    }\n    else if(h6) {\n        result.name = h6.innerText;\n        result.price = catalog_dom.querySelector('.order_g > table td').innerText\n            .replace(/\\s+/g, ' ');\n    }\n    else {\n        return null;\n    }\n\n    result.name = result.name\n        .replace(/\\s+/g, ' ')\n        .replace(/[Ａ-Ｚａ-ｚ０-９]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0))// 全角英数字 -> 半角英数字\n        .replace(ZenkakuFigReg, s => ZenkakuFig[s])\n    result.price = result.price.replace(/合計[\\s\\S]+$/, '').trim();\n\n    const icon = await fetch(`https://akizukidenshi.com/img/goods/S/${id}.jpg`);\n    const icon_base64 = await Blob2Base64(await icon.blob());\n    \n    const info = await fetch(`https://akizukidenshi.com/catalog/goods/warehouseinfo.aspx?goods=${id}`);\n    const info_dom = Decode_ShiftJis_Dom(await info.arrayBuffer());\n\n    const stock = [...info_dom.querySelectorAll('tr:not([align])')]\n        .map(tr => {\n            const obj = {};\n            const tds = tr.querySelectorAll('td');\n            obj.name = tds[0].innerText.trim();\n            obj.limit = tds[1].innerText.trim();\n            obj.location = tds[2].innerText.trim();\n            return obj;\n    });\n    \n    result.id = id;\n    result.icon = icon_base64;\n    result.count = 1;\n\n    result.stock = stock.reduce((p, v) => {\n        if(v.name == '秋葉原店') {\n            v.cabinet = v.location.match(/\\s(\\d{2})/)?.[1] || null;\n        }\n        p[v.name] = v;\n        return p;\n    }, {});\n\n    return result;\n};*/","import { ParseItem } from \"./parse.js\";\n\n\nexport const getItemList = () => new Promise(r => {\n    chrome.storage.local.get(['__akizuki_my_item_list'], items => r([...(items['__akizuki_my_item_list'] || [])]));\n});\n\nexport const changeItemList = async callback => {\n    const list = await getItemList();\n    const newlist = await callback(list);\n    return await new Promise(r => {\n        chrome.storage.local.set({\n            '__akizuki_my_item_list': newlist\n                .sort((a, b) => Number(a.stock['秋葉原店'].cabinet) - Number(b.stock['秋葉原店'].cabinet))\n        }, async () => {\n            r(await getItemList());\n        });\n    });\n};\n\nexport const addItem = async id => {\n    const newlist = await changeItemList(async list => {\n        const same = list.find(item => item.id == id);\n        const newitem = await ParseItem(id);\n        return same || !newitem\n          ? list\n          : [...list, newitem];\n    });\n    return newlist;\n};\n\nexport const reloadItemList = async (progress_callback = n => {}) => changeItemList(async list => {\n    let n = 1;\n    progress_callback(0);\n    const newlist = await Promise.all(list.map(async item => {\n        const reloadedItem = await ParseItem(item.id);\n        progress_callback(n++ / list.length);\n        if(!reloadedItem) return null;\n        return {...reloadedItem, count: item.count};\n    }))\n    console.log(newlist)\n    return newlist.filter(v => v);\n});\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","import { addItem } from './util.js';\n\nconst style = document.createElement('style');\nstyle.innerHTML = `\n.__akizuki_info_box {\n    animation: __akizuki_info_box_close_animation .35s ease-in 1s forwards;\n    position: fixed;\n    pointer-events: none;\n    user-select: none;\n    top: 1em;\n    left: 0;\n    right: 0;\n    margin: 0 auto;\n    background: #ffcc99;\n    border: 1px solid #aaa;\n    box-shadow: 0 0 3px #fff, 0 0 6px #fff, 0 0 9px #fff;\n    color: #733;\n    font-size: 1.5em;\n    opacity: 1;\n    padding: .5em;\n    text-align: center;\n    width: 35%;\n    max-width: 190px;\n}\n@keyframes __akizuki_info_box_close_animation {\n  0%,30% { opacity: 1; }\n  100%   { opacity: 0; }\n}\n`;\ndocument.head.appendChild(style);\n\nconst info = document.createElement('div');\ninfo.classList.add('__akizuki_info_box', '__akizuki_close', '__akizuki_init');\n\n// Listen for message\nchrome.runtime.onMessage.addListener(async (request, sender, sendResponse) => {\n    if(request.name == 'add_item') {\n        const { id } = request.payload;\n        await addItem(id);\n        console.log(id);\n        info.remove();\n        info.innerHTML = `${id}を追加`;\n        document.body.appendChild(info);\n    }\n\n  // Send an empty response\n  // See https://github.com/mozilla/webextension-polyfill/issues/130#issuecomment-531531890\n  //sendResponse({});\n  //return true;\n});\n"],"names":[],"sourceRoot":""}